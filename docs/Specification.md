## スマホ向け棚卸アプリ 仕様書（ドラフト）

### 1. 概要
- **目的**: 現場でQRコードを読み取り、同一型番ごとの数量を迅速かつ正確に集計するスマホ向けWebアプリ。
- **対象ユーザー**: 製造業の現場担当者、在庫担当者、検品担当者。
- **特徴**: インストール不要（PWA化予定）、オフライン対応、設定可能な型番抽出ロジック、CSVエクスポート。

### 2. 対象プラットフォーム / ブラウザ
- **スマホOS**: iOS 15+ / Android 10+
- **ブラウザ**: Safari, Chrome, Edge（最新および一つ前のメジャー）
- **カメラアクセス**: `getUserMedia` を使用。端末が非対応・拒否時は画像アップロードで代替読取を提供（縮小処理後にQR解析）。

### 3. 制約と採用技術
- **実装制約**: 追加ビルド環境禁止。静的ファイルのみで構成（`HTML5`, `CSS3`, `JavaScript(ES6+)`）。外部ライブラリはCDNのみ許可。
- **QR読取ライブラリ（候補）**: ZXing または jsQR（いずれもCDN経由）。
- **データ保存**: ブラウザ `localStorage`。ユーザー明示操作でCSV出力（インポートはMVP未対応）。
- **UI/UX**: `Design_rules.md` に準拠（カラー、タイポ、余白、ボタン/カード、フィードバック）。

### 4. ユースケース
- 型番の在庫数量を現場で素早くカウントしたい。
- スキャンミス時に直前の操作を取り消したい（Undo）。
- 集計結果をCSVで持ち出し、既存基幹システムに取り込む。
- 型番の埋め込み位置が変わるQRに現場で対応したい（開始位置/正規表現の切替）。

### 5. 機能仕様
#### 5.1 QRスキャン
- リアルタイムプレビュー上でQRを検出し、デコードに成功したら自動で型番抽出→集計へ反映。
- 連続スキャンに対応（重複連打防止のクールダウン ms 設定あり）。
- 成功時の視覚/音/バイブ通知（設定でON/OFF）。
- カメラ切替（複数カメラ端末で背面優先、非対応時は自動フォールバック）。

#### 5.2 型番抽出ロジック
- 方式: 「QR文字列の N 文字目以降を型番とみなす」のみを採用。初期値 N=50。
- 抽出範囲: N文字目以降すべてを型番とする（区切り文字は使用しない）。
- 正規化: 不要（大文字化/ハイフン統一は行わない）。前後空白はトリム。
- 設定反映: 設定画面で N を変更可能。

#### 5.3 設定
- 抽出方式: 開始位置（N）のみ（初期値 50、入力制約: 0〜500の整数）。
- スキャン挙動: 重複クールダウン(ms) 初期値 100（入力制約: 50〜2000の整数, 1刻み）、ビープ音 ON、バイブ ON。
- データ: CSVエクスポート、全消去（確認ダイアログ）、設定のリセット（初期化）。
- 永続化: すべて localStorage に保存（キーは 6. データ仕様参照）。

#### 5.4 集計
- 集計単位: 型番。
- 画面: 型番一覧（並び順: 型番昇順）、数量の+/-。検索ボックスは無し。
- バッジ: 新規追加/更新直後に一時ハイライト。

#### 5.5 履歴
- 本MVPで提供する。最新順に表示。
- 項目: `ts`（UNIX ms）, `model`（型番）, `delta`（数量変化, +1/-1）, `raw`（QR生文字列）。
- 操作: 再適用（やり直し）なし、閲覧専用。削除は個別/全消去（確認ダイアログ）。
- 保存上限: 1000件（超過時は最古から削除）。

#### 5.6 データ入出力
- エクスポート: CSV（UTF-8, LF, ヘッダー行あり）。列定義:
    - model: 型番（文字列）
    - quantity: 数量（整数, 0以上）
- 並び順: 型番昇順。
- ファイル名: `inventory_YYYYMMDD.csv`（例: `inventory_20250821.csv`）。
- 値のエスケープ: カンマ/改行/二重引用符を含む値は RFC4180 に従い二重引用符で囲み、内部の二重引用符は二重化する。
- 文字コード/改行: UTF-8（BOMなし）/LF。
- インポート: 本MVPでは未対応。

#### 5.7 フィードバック/エラー
- 成功: グリーンのトースト/スナック、数量変化の視覚アニメーション。
- 失敗: エラー表示（赤）、原因/対処を併記（例: カメラ権限、QR不鮮明）。
- ローディング: スケルトン/スピナー。

#### 5.8 アクセシビリティ
- タップ領域48px以上、コントラスト比 AA 以上、フォーカス可視、全操作をキーボードで代替可能。

### 6. データ仕様
- ストレージキー
    - `inventory.settings`: 設定オブジェクト
    - `inventory.counts`: 集計（型番→数量）
    - `inventory.history`: 履歴配列
- 設定オブジェクト（例）
```json
{
    "extraction": {
        "startIndex": 50
    },
    "scan": { "cooldownMs": 100, "beep": true, "vibrate": true },
    "camera": { "deviceId": "", "resolution": "hd" },
    "ui": { "theme": "system" }
}
```
- 集計（例）
```json
{
    "AB-123": 42,
    "ZX-999": 7
}
```
- 履歴（例）
```json
[
    { "ts": 1719990000000, "model": "AB-123", "delta": +1, "raw": "...QR RAW..." }
]
```

### 7. 画面仕様（概要）
- ダッシュボード: 集計サマリ、エクスポート、スキャン開始ボタン。
- スキャン画面: カメラプレビュー、ガイド枠、結果プレビュー、再生/停止、カメラ切替。
- 集計画面: 型番リスト、数量編集（±ボタン）、検索/フィルタなし。
- 設定画面: 5.3 の各項目。入力バリデーション、サンプルテスト機能（テキストにQR生文字列を貼って抽出結果を即時確認）。
- 履歴画面: 5.5 の一覧（閲覧専用、再適用なし）。

### 8. ルール準拠
- `develop_rules.md` に定める技術・構造・SEO・品質要件に準拠。
- `Design_rules.md` のカラー/タイポ/余白/影/ボタン/フィードバック方針をUI全体に適用。

### 9. セキュリティ/プライバシー
- HTTPS必須、カメラ権限の最小化、外部送信なし（完全ローカル）。
- XSS対策: 画面表示時のエスケープ、正規表現入力の検証（危険な後読みなどを制限）。

### 10. パフォーマンス/品質
- 目標: 連続スキャン 5件/秒でもUIブロック無し。Core Web Vitals「良好」。
- 画像処理は必要最低限（プレビュー解像度調整、デコードはWebWorker化を検討）。

### 11. ログ/デバッグ
- `develop_rules.md` の `debug-utils.js` と統合。操作ログは開発時のみ保存・出力（ユーザー操作: 任意でダウンロード）。

### 12. 今後の拡張
- PWA対応（オフラインキャッシュ、ホーム画面追加）。
- バーコード（Code128等）対応、複数QR同時検出、ロールバックの時系列編集。

### 13. 受入基準（例）
- 型番抽出: `startIndex=50` 設定時にQRの51文字目以降を型番として正しく集計。
- 履歴: 最新順で閲覧でき、個別/全消去が動作する。
- 連続スキャン時の重複抑止が機能し、数量が意図せず増え続けない。
- 設定・集計・履歴が再読込後も保持される。
- CSVエクスポートが仕様フォーマットで出力される。

### 14. ファイル構成（予定）
```
project-root/
├── index.html
├── pages/
│   ├── scan.html
│   ├── settings.html
│   ├── history.html
│   └── summary.html
├── common/
│   ├── header.html
│   ├── footer.html
│   └── navigation.html
├── assets/
│   ├── css/
│   │   ├── common.css
│   │   ├── components.css
│   │   └── pages.css
│   ├── js/
│   │   ├── common.js
│   │   ├── components.js
│   │   └── tools/
│   │       └── scanner.js
│   └── icons/
├── docs/
│   ├── Specification.md
│   ├── README.md
│   └── CHANGELOG.md
└── tests/
    ├── unit/
    └── integration/
```

#### 7.1 スキャン画面（詳細）
- コンポーネント:
    - カメラプレビュー（video, 背面優先, ミラーなし）
    - スキャンガイド枠（中央スクエア overlay）
    - ステータス表示（読み取り中/成功/失敗）
    - ボタン: 「停止/再開」, 「カメラ切替」
    - トースト: 成功時（model, +1）, エラー時（原因）
- 挙動:
    - 画面表示で自動開始（権限ダイアログ→許可後に開始）
    - デコード成功: 抽出→集計へ+1→履歴に {ts, model, delta:+1, raw} を追加→トースト→クールダウン適用
    - クールダウン中のデコード結果: 全てカウント（ユーザー指定により決定済み）
    - 失敗時: エラー表示（例: カメラ権限不可/デコード失敗）。連続失敗でもUIはブロックしない
    - 非対応/拒否時: 画像アップロードにフォールバック（縮小処理後に単発解析）
- エラー表示例:
    - カメラ権限が拒否されました
    - デコードに失敗しました（QRを枠内に近づけてください）

#### 7.2 集計画面（詳細）
- リスト: 型番（左）/ 数量（中央）/ 「-」「+」ボタン（右）
- 並び順: 型番昇順（A→Z→a→z→数字）
- 操作:
    - 「+」: 数量+1、履歴に {ts, model, delta:+1, raw:""} 追加
    - 「-」: 数量-1（0未満は不可。0で止まる）、履歴に {ts, model, delta:-1, raw:""} 追加
- 表示仕様:
    - 数量が0でも行は残す（誤操作時の回復容易性を優先）
    - 直後に一時ハイライト（更新フィードバック）

#### 7.3 設定画面（詳細）
- フィールド:
    - 開始位置N: number input（min:0, max:500, step:1, 初期50）
    - クールダウンms: number input（min:50, max:2000, step:1, 初期100）
    - ビープ音: toggle（初期ON）
    - バイブ: toggle（初期ON）
- アクション:
    - 保存（即時 localStorage 反映）
    - 設定のリセット（初期値へ）。確認ダイアログあり
    - データ全消去（counts, history を削除）。確認ダイアログあり
    - CSVエクスポート（counts を出力）
- 入力時の挙動:
    - 異常値は保存不可（エラーメッセージ表示）

#### 7.4 履歴画面（詳細）
- 一覧: 最新順（上→下）。列: 日時（ローカル時刻）, 型番, 変化（+1 / -1）, 生文字列（先頭64文字を表示、フルはツールチップ）
- 操作: 行削除（確認ダイアログ）, 全削除（確認ダイアログ）
- 保存上限: 1000件。超過時は最古から自動削除

#### 7.5 ダッシュボード（詳細）
- カード:
    - 総型番数（unique models）
    - 合計数量（counts の合計）
- アクション: 「スキャンを開始」, 「CSVエクスポート」

### 15. バリデーション一覧（確定）
- settings.extraction.startIndex
    - 型: 整数、範囲: 0〜500
    - 保存時: 範囲外はエラー
    - テスト入力（設定画面のサンプル欄）で、QR生文字列長 ≤ N の場合は「抽出結果が空」の警告
- settings.scan.cooldownMs
    - 型: 整数、範囲: 50〜2000（ms）
    - 保存時: 範囲外はエラー
- settings.scan.beep / settings.scan.vibrate
    - 型: boolean
- counts[model]
    - 型: 整数、範囲: 0〜999999（上限に達したらそれ以上は加算しない）
- history[] 要素
    - ts: 整数（UNIX epoch ms）
    - model: 文字列（トリム後、空は不可、最大長 256）
    - delta: 整数（+1 または -1 のみ）
    - raw: 文字列（任意、最大長 2048）。手動操作時は "" を格納

### 16. ストレージスキーマ（確定）
- localStorage キー:
    - `inventory.settings`: 設定オブジェクト
    - `inventory.counts`: 集計（型番→数量）
    - `inventory.history`: 履歴配列（最大1000件）
    - `inventory.version`: スキーマバージョン（数値, 初期 1）
- `inventory.settings` 例と型
```json
{
    "extraction": { "startIndex": 50 },
    "scan": { "cooldownMs": 100, "beep": true, "vibrate": true },
    "camera": { "deviceId": "", "resolution": "hd" },
    "ui": { "theme": "system" }
}
```
- `inventory.counts` 例と型
```json
{
    "AB-123": 42,
    "ZX-999": 7
}
```
- `inventory.history` 例と型
```json
[
    { "ts": 1719990000000, "model": "AB-123", "delta": 1, "raw": "..." }
]
```
- マイグレーション方針
    - `inventory.version` 不一致時は、既存データを安全に読み込みつつ不足項目を初期値で補完し、保存時に最新バージョンへ更新 